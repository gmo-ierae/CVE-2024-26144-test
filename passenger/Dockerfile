FROM ruby:3.2.2-bookworm

RUN gem install passenger -v 6.0.22

# nginx installed in /opt/nginx/sbin/nginx
RUN passenger-install-nginx-module --auto

# bundle install
WORKDIR /app
RUN gem install bundler
COPY ./rails-app /app
RUN bundle install

COPY ./passenger/nginx.conf /opt/nginx/conf/

CMD [ "bash", "-c", "export SECRET_KEY_BASE=$(ruby -e \"require 'securerandom'; puts SecureRandom.hex(64)\"); export RAILS_ENV=production; bundle exec rake db:migrate; bundle exec rake db:seed; chown -R nobody /app/; /opt/nginx/sbin/nginx -g 'daemon off;'" ]